<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KutEA26 - EA Control Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2d;
      --panel-2: #16213a;
      --line: #27324b;
      --text: #dbe6ff;
      --muted: #8ea2cc;
      --brand: #35c6ff;
      --ok: #23d18b;
      --bad: #ff5f6d;
      --warn: #ffb454;
      --accent: #5aa8ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(1200px 700px at 10% -10%, #132340 0%, var(--bg) 45%);
      color: var(--text);
    }
    .hidden { display: none !important; }
    .lock-screen { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .auth-card {
      width: min(420px, 100%);
      background: linear-gradient(180deg, #13213b 0%, #0f192e 100%);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      padding: 24px;
    }
    .auth-title { margin: 0 0 8px; font-size: 1.6rem; }
    .auth-sub { margin: 0 0 20px; color: var(--muted); font-size: 0.95rem; }
    .field { margin-bottom: 14px; }
    .field label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 0.86rem; }
    input, select, button {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0c1528;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }
    input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 2px rgba(53, 198, 255, 0.16); }
    button { cursor: pointer; font-weight: 600; transition: 0.2s ease; }
    .btn-primary { background: linear-gradient(180deg, #4ec5ff, #1e99ff); color: #041022; border: none; }
    .btn-primary:hover { transform: translateY(-1px); }
    .error { color: var(--bad); min-height: 20px; font-size: 0.9rem; margin-top: 8px; }
    .app { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
    .sidebar {
      background: #0c1526;
      border-right: 1px solid var(--line);
      padding: 18px;
      position: sticky;
      top: 0;
      height: 100vh;
    }
    .brand { font-size: 1.1rem; font-weight: 700; margin-bottom: 18px; color: #b7d2ff; }
    .nav-link {
      display: block;
      color: var(--muted);
      text-decoration: none;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .nav-link:hover { background: #14213a; color: var(--text); }
    .nav-link.active {
      background: linear-gradient(180deg, #1a2f54, #152746);
      color: #dce9ff;
      border: 1px solid #27406a;
    }
    .contact-btn {
      margin-top: 10px;
      display: block;
      width: 100%;
      text-align: center;
      text-decoration: none;
      border-radius: 10px;
      border: 1px solid #2d5e4d;
      background: linear-gradient(180deg, #2c8f6c, #216b50);
      color: #eafff6;
      padding: 10px 12px;
      font-weight: 600;
    }
    .contact-btn:hover { filter: brightness(1.06); }
    .logout-btn { margin-top: 16px; background: #1a243b; color: #f0f5ff; }
    .content { padding: 20px; display: grid; gap: 14px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .chip {
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 0.85rem;
      background: #0f1a2f;
    }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .card {
      grid-column: span 12;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }
    .card h3 { margin: 0 0 10px; font-size: 1rem; }
    .section-panel {
      display: none;
      animation: panelFade 0.2s ease;
    }
    .section-panel.active { display: block; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0f1a2d;
      min-height: 42px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--bad);
      box-shadow: 0 0 10px rgba(255, 95, 109, 0.7);
    }
    .dot.ok { background: var(--ok); box-shadow: 0 0 10px rgba(35, 209, 139, 0.8); }
    .hint { color: var(--muted); font-size: 0.85rem; }
    .btn-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .btn-start { background: #0f8f60; border-color: #0f8f60; }
    .btn-stop { background: #a33a45; border-color: #a33a45; }
    .btn-restart { background: #2853b3; border-color: #2853b3; }
    .btn-backend-connect { background: #1c6bb7; border-color: #1c6bb7; margin-top: 8px; }
    .btn-backend-disconnect { background: #8a2f3f; border-color: #8a2f3f; margin-top: 8px; }
    .backend-state { margin-top: 8px; }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      font-size: 0.9rem;
    }
    th, td {
      border-bottom: 1px solid var(--line);
      padding: 10px;
      text-align: left;
      white-space: nowrap;
    }
    thead { background: #0f1a2f; }
    .pnl-pos { color: var(--ok); }
    .pnl-neg { color: var(--bad); }
    .log-box {
      background: #0a1324;
      border: 1px solid var(--line);
      border-radius: 10px;
      height: 220px;
      overflow: auto;
      padding: 10px;
      font-family: Consolas, monospace;
      font-size: 0.85rem;
    }
    .log-line { margin: 0 0 6px; color: #aecdff; }
    .log-line .t { color: #7aa8ff; }
    .chart-controls {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    .chart-wrap {
      border: 1px solid var(--line);
      background: #0a1324;
      border-radius: 10px;
      padding: 10px;
    }
    #marketChart {
      width: 100%;
      height: 300px;
      display: block;
    }
    #chartMeta {
      margin-top: 8px;
      color: var(--muted);
      font-size: 0.88rem;
    }
    .symbol-jump {
      width: auto;
      padding: 2px 6px;
      border: 1px solid #2f4f83;
      background: #132341;
      color: #a9d4ff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.84rem;
    }
    .symbol-jump:hover {
      background: #173159;
      color: #dcefff;
    }
    @keyframes panelFade {
      from { opacity: 0; transform: translateY(3px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .col-4, .col-6 { grid-column: span 12; }
      .btn-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <section id="lockScreen" class="lock-screen">
    <div class="auth-card">
      <h1 class="auth-title">KutEA26 Access</h1>
      <p class="auth-sub">Authenticate to open your EA control dashboard.</p>
      <form id="loginForm" autocomplete="off">
        <div class="field">
          <label for="username">Username</label>
          <input id="username" type="text" required />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" required />
        </div>
        <button class="btn-primary" type="submit">Login</button>
      </form>
      <div id="authError" class="error"></div>
    </div>
  </section>

  <main id="app" class="app hidden">
    <aside class="sidebar">
      <div class="brand">KutEA26 Dashboard</div>
      <a class="nav-link" href="#brokerPanel" data-target="brokerPanel">Broker Connection</a>
      <a class="nav-link" href="#uploadPanel" data-target="uploadPanel">Upload & Settings</a>
      <a class="nav-link" href="#controlPanel" data-target="controlPanel">EA Control</a>
      <a class="nav-link" href="#marketPanel" data-target="marketPanel">Market Chart</a>
      <a class="nav-link" href="#livePanel" data-target="livePanel">Live Transactions</a>
      <a class="nav-link" href="#historyPanel" data-target="historyPanel">History</a>
      <a class="nav-link" href="#logPanel" data-target="logPanel">System Log</a>
      <a id="contactAdminBtn" class="contact-btn" href="https://t.me/KutMilz876" target="_blank" rel="noopener noreferrer">Contact Admin</a>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </aside>

    <section class="content">
      <div class="topbar">
        <div class="chip">EA: KutEA26</div>
        <div class="chip" id="runStateChip">Engine: Idle</div>
      </div>

      <div class="grid">
        <article id="brokerPanel" class="card section-panel">
          <h3>Broker Connection Panel</h3>
          <div class="row">
            <div class="col-4">
              <label class="hint">Backend API URL</label>
              <input id="apiBase" type="text" value="http://127.0.0.1:8787" />
              <button id="backendApiBtn" class="btn-backend-connect" type="button">Connect Backend</button>
              <div id="backendApiStatus" class="hint backend-state">Backend: Disconnected</div>
            </div>
            <div class="col-4">
              <label class="hint">Select Broker</label>
              <select id="brokerSelect">
                <option value="">-- Select --</option>
                <option value="Deriv">Deriv</option>
                <option value="MetaTrader5">MetaTrader5</option>
              </select>
            </div>
            <div class="col-4">
              <label class="hint">Compatibility</label>
              <div id="compatibilityLabel" class="status">Broker accepted by MetaTrader5</div>
            </div>
            <div class="col-4">
              <label class="hint">Broker Account Login</label>
              <input id="brokerLogin" type="text" placeholder="e.g. 12345678" />
            </div>
            <div class="col-4">
              <label class="hint">Broker Password</label>
              <input id="brokerPassword" type="password" placeholder="Broker password" />
            </div>
            <div class="col-4">
              <label class="hint">Broker Server</label>
              <input id="brokerServer" type="text" placeholder="e.g. Deriv-Server" />
            </div>
            <div class="col-6">
              <label class="hint">MT5 Terminal Path (Optional)</label>
              <input id="brokerTerminalPath" type="text" placeholder="C:\\Program Files\\MetaTrader 5\\terminal64.exe" />
            </div>
            <div class="col-4">
              <label class="hint">Status</label>
              <div class="status"><span id="brokerDot" class="dot"></span><span id="brokerStatus">Disconnected</span></div>
            </div>
            <div class="col-4">
              <button id="connectBtn" class="btn-primary" type="button">Connect Broker</button>
            </div>
          </div>
        </article>

        <article id="uploadPanel" class="card section-panel">
          <h3>Upload EA (.mq5) + Dynamic Settings</h3>
          <div class="row">
            <div class="col-6">
              <label class="hint">Upload File</label>
              <input id="mq5File" type="file" accept=".mq5" />
            </div>
            <div class="col-6">
              <label class="hint">Loaded File</label>
              <div id="fileName" class="status">No file loaded</div>
            </div>
            <div class="col-12 hint">Only <code>.mq5</code> files are accepted. Inputs are parsed and rendered below.</div>
          </div>
          <hr style="border-color: var(--line); opacity: .5"/>
          <div id="settingsPanel" class="row"></div>
        </article>

        <article id="controlPanel" class="card section-panel">
          <h3>EA Control Panel</h3>
          <div class="btn-row">
            <button id="startBtn" class="btn-start" type="button">Start EA</button>
            <button id="stopBtn" class="btn-stop" type="button">Stop EA</button>
            <button id="restartBtn" class="btn-restart" type="button">Restart EA</button>
          </div>
        </article>

        <article id="marketPanel" class="card section-panel">
          <h3>Market Chart</h3>
          <div class="chart-controls">
            <div class="col-6">
              <label class="hint">Selected Market Symbol</label>
              <select id="chartSymbol">
                <option value="">No symbols yet</option>
              </select>
            </div>
            <div class="col-6">
              <label class="hint">Data Source</label>
              <div class="status">Live trade snapshots from backend polling</div>
            </div>
          </div>
          <div class="chart-wrap">
            <canvas id="marketChart"></canvas>
            <div id="chartMeta">Waiting for market data...</div>
          </div>
        </article>

        <article id="livePanel" class="card section-panel">
          <h3>Live Transactions</h3>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Trade ID</th>
                  <th>Symbol</th>
                  <th>Lot Size</th>
                  <th>Entry Price</th>
                  <th>Current Price</th>
                  <th>Profit/Loss</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="liveBody"></tbody>
            </table>
          </div>
        </article>

        <article id="historyPanel" class="card section-panel">
          <h3>Transaction History Log</h3>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Trade ID</th>
                  <th>Symbol</th>
                  <th>Entry</th>
                  <th>Exit</th>
                  <th>Profit/Loss</th>
                  <th>Close Time</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </article>

        <article id="logPanel" class="card section-panel">
          <h3>System Log Panel</h3>
          <div id="systemLog" class="log-box"></div>
        </article>
      </div>
    </section>
  </main>

  <script>
    // Real-mode dashboard with backend bridge.
    const bus = new EventTarget();
    const state = {
      authenticated: false,
      connected: false,
      mq5Loaded: false,
      eaRunning: false,
      backendApiOnline: false,
      apiSessionToken: "",
      settings: {},
      parameters: [],
      trades: [],
      history: [],
      marketSeries: {},
      selectedSymbol: "",
      activePanel: "brokerPanel",
      seenLogs: new Set(),
      poller: null
    };

    // Login logic.
    const USERNAME = "KutEA26";
    const PASS_HASH = "68a242c130a1c9254dbd2bb44ab18d787c40dc13eae775b103e086ccf17ce3a3"; // "$money"

    const el = {
      lockScreen: document.getElementById("lockScreen"),
      app: document.getElementById("app"),
      loginForm: document.getElementById("loginForm"),
      username: document.getElementById("username"),
      password: document.getElementById("password"),
      authError: document.getElementById("authError"),
      apiBase: document.getElementById("apiBase"),
      backendApiBtn: document.getElementById("backendApiBtn"),
      backendApiStatus: document.getElementById("backendApiStatus"),
      brokerSelect: document.getElementById("brokerSelect"),
      brokerLogin: document.getElementById("brokerLogin"),
      brokerPassword: document.getElementById("brokerPassword"),
      brokerServer: document.getElementById("brokerServer"),
      brokerTerminalPath: document.getElementById("brokerTerminalPath"),
      connectBtn: document.getElementById("connectBtn"),
      compatibilityLabel: document.getElementById("compatibilityLabel"),
      brokerDot: document.getElementById("brokerDot"),
      brokerStatus: document.getElementById("brokerStatus"),
      mq5File: document.getElementById("mq5File"),
      fileName: document.getElementById("fileName"),
      settingsPanel: document.getElementById("settingsPanel"),
      startBtn: document.getElementById("startBtn"),
      stopBtn: document.getElementById("stopBtn"),
      restartBtn: document.getElementById("restartBtn"),
      runStateChip: document.getElementById("runStateChip"),
      navLinks: Array.from(document.querySelectorAll(".nav-link[data-target]")),
      panels: Array.from(document.querySelectorAll(".section-panel")),
      chartSymbol: document.getElementById("chartSymbol"),
      marketChart: document.getElementById("marketChart"),
      chartMeta: document.getElementById("chartMeta"),
      liveBody: document.getElementById("liveBody"),
      historyBody: document.getElementById("historyBody"),
      systemLog: document.getElementById("systemLog"),
      logoutBtn: document.getElementById("logoutBtn")
    };

    function nowTime() { return new Date().toLocaleTimeString(); }
    function apiBase() { return (el.apiBase.value || "").trim().replace(/\/$/, ""); }
    function isFileMode() { return window.location.protocol === "file:"; }

    function log(message, remote = false) {
      const key = remote ? `r:${message}` : `l:${message}`;
      if (state.seenLogs.has(key)) return;
      state.seenLogs.add(key);
      const p = document.createElement("p");
      p.className = "log-line";
      p.innerHTML = `<span class="t">[${nowTime()}]</span> ${message}`;
      el.systemLog.appendChild(p);
      el.systemLog.scrollTop = el.systemLog.scrollHeight;
      bus.dispatchEvent(new CustomEvent("log", { detail: message }));
    }

    async function sha256(text) {
      const bytes = new TextEncoder().encode(text);
      const hash = await crypto.subtle.digest("SHA-256", bytes);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function fetchApiSessionToken(force = false) {
      if (state.apiSessionToken && !force) return state.apiSessionToken;
      const base = apiBase();
      if (!base) throw new Error("Backend API URL is empty");
      const res = await fetch(`${base}/api/session`, { method: "GET" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false || !data.token) {
        throw new Error(data.error || `Session init failed (${res.status})`);
      }
      state.apiSessionToken = String(data.token);
      return state.apiSessionToken;
    }

    async function api(path, options = {}) {
      const base = apiBase();
      if (!base) throw new Error("Backend API URL is empty");
      const url = `${base}${path}`;
      let triedRefresh = false;

      while (true) {
        const headers = { ...(options.headers || {}) };
        if (path !== "/api/session") {
          const token = await fetchApiSessionToken(triedRefresh);
          headers["X-KutEA-Session"] = token;
        }

        const fetchOpts = { method: options.method || "GET", headers };
        if (options.formData) {
          fetchOpts.body = options.formData;
        } else if (options.body !== undefined) {
          fetchOpts.headers["Content-Type"] = "application/json";
          fetchOpts.body = JSON.stringify(options.body);
        }

        const res = await fetch(url, fetchOpts);
        const data = await res.json().catch(() => ({}));

        if (res.status === 401 && !triedRefresh && path !== "/api/session") {
          state.apiSessionToken = "";
          triedRefresh = true;
          continue;
        }

        if (!res.ok || data.ok === false) {
          throw new Error(data.error || `Request failed (${res.status})`);
        }
        return data;
      }
    }

    async function handleLogin(evt) {
      evt.preventDefault();
      el.authError.textContent = "";
      const user = el.username.value.trim();
      const passHash = await sha256(el.password.value);
      if (user !== USERNAME || passHash !== PASS_HASH) {
        el.authError.textContent = "Invalid login credentials";
        return;
      }
      const session = { token: btoa(`${user}:${Date.now()}`), exp: Date.now() + 8 * 60 * 60 * 1000 };
      sessionStorage.setItem("kutea26_session", JSON.stringify(session));
      setAuthenticated(true);
      log("Authentication successful");
      const ok = await connectBackendApi(false);
      if (!ok) {
        log("Backend not connected. Set Backend API URL and click Connect Backend.");
      }
    }

    function setAuthenticated(ok) {
      state.authenticated = ok;
      el.lockScreen.classList.toggle("hidden", ok);
      el.app.classList.toggle("hidden", !ok);
    }

    function loadSession() {
      try {
        const raw = sessionStorage.getItem("kutea26_session");
        if (!raw) return setAuthenticated(false);
        const sess = JSON.parse(raw);
        if (!sess?.exp || Date.now() > sess.exp) {
          sessionStorage.removeItem("kutea26_session");
          return setAuthenticated(false);
        }
        setAuthenticated(true);
        connectBackendApi(false).then(ok => {
          if (!ok) log("Backend not connected. Set Backend API URL and click Connect Backend.");
        });
      } catch {
        setAuthenticated(false);
      }
    }

    function logout() {
      sessionStorage.removeItem("kutea26_session");
      disconnectBackendApi(false);
      setAuthenticated(false);
    }

    function setBackendApiState(online, text = "") {
      state.backendApiOnline = !!online;
      el.backendApiStatus.textContent = `Backend: ${text || (online ? "Connected" : "Disconnected")}`;
      el.backendApiBtn.textContent = online ? "Disconnect Backend" : "Connect Backend";
      el.backendApiBtn.classList.toggle("btn-backend-connect", !online);
      el.backendApiBtn.classList.toggle("btn-backend-disconnect", online);
    }

    function disconnectBackendApi(logMessage = true) {
      stopPolling();
      state.apiSessionToken = "";
      setBackendApiState(false, "Disconnected");
      if (logMessage) log("Backend API disconnected");
    }

    async function connectBackendApi(manual = false) {
      try {
        await fetchApiSessionToken(true);
        await api("/api/health");
        setBackendApiState(true, "Connected");
        startPolling();
        if (manual) log("Backend API connected");
        return true;
      } catch (err) {
        disconnectBackendApi(false);
        if (manual || !isFileMode()) log(`Backend connect error: ${err.message}`);
        return false;
      }
    }

    async function toggleBackendApi() {
      if (state.backendApiOnline) {
        disconnectBackendApi(true);
        return;
      }
      await connectBackendApi(true);
    }

    function showPanel(panelId, updateHash = true) {
      const exists = el.panels.some(p => p.id === panelId);
      const target = exists ? panelId : "brokerPanel";
      state.activePanel = target;
      el.panels.forEach(p => p.classList.toggle("active", p.id === target));
      el.navLinks.forEach(link => link.classList.toggle("active", link.dataset.target === target));
      if (updateHash && window.location.hash !== `#${target}`) {
        history.replaceState(null, "", `#${target}`);
      }
      if (target === "marketPanel") {
        requestAnimationFrame(drawMarketChart);
      }
    }

    function initPanels() {
      el.navLinks.forEach(link => {
        link.addEventListener("click", (evt) => {
          evt.preventDefault();
          showPanel(link.dataset.target || "brokerPanel");
        });
      });
      const fromHash = (window.location.hash || "").replace("#", "").trim();
      showPanel(fromHash || "brokerPanel", false);
      window.addEventListener("hashchange", () => {
        const target = (window.location.hash || "").replace("#", "").trim();
        if (target) showPanel(target, false);
      });
    }

    function setBrokerStatus(connected, text) {
      state.connected = !!connected;
      el.brokerStatus.textContent = connected ? (text || "Connected") : (text || "Disconnected");
      el.brokerDot.classList.toggle("ok", connected);
    }

    function prettyName(raw) {
      return raw.replace(/^Inp/, "").replace(/([a-z0-9])([A-Z])/g, "$1 $2").trim();
    }

    function cleanDefault(v) { return String(v ?? "").replace(/^"|"$/g, ""); }

    function makeField(param) {
      const wrap = document.createElement("div");
      wrap.className = "col-4";
      const label = document.createElement("label");
      label.className = "hint";
      label.textContent = prettyName(param.name);
      const t = String(param.type || "").toLowerCase();
      const id = `set_${param.name}`;
      let ctrl;

      if (t === "bool") {
        ctrl = document.createElement("select");
        ctrl.innerHTML = `<option value="true">true</option><option value="false">false</option>`;
        const d = cleanDefault(param.defaultValue).toLowerCase();
        ctrl.value = (d === "true" || d === "1") ? "true" : "false";
      } else if (t.includes("timeframes") || t.includes("enum_timeframes")) {
        ctrl = document.createElement("select");
        ["PERIOD_M1","PERIOD_M5","PERIOD_M15","PERIOD_H1","PERIOD_H4","PERIOD_D1"].forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v;
          ctrl.appendChild(o);
        });
        ctrl.value = cleanDefault(param.defaultValue);
      } else {
        ctrl = document.createElement("input");
        ctrl.type = "text";
        ctrl.value = cleanDefault(param.defaultValue);
      }
      ctrl.id = id;
      ctrl.dataset.param = param.name;
      ctrl.dataset.type = param.type;
      wrap.appendChild(label);
      wrap.appendChild(ctrl);
      return wrap;
    }

    function buildSettingsPanel(params) {
      el.settingsPanel.innerHTML = "";
      if (!params?.length) {
        log("EA parameter parse returned empty list");
        return;
      }
      params.forEach(p => el.settingsPanel.appendChild(makeField(p)));
      log(`EA Loaded Successfully - ${params.length} inputs parsed`);
    }

    function collectSettings() {
      const controls = el.settingsPanel.querySelectorAll("[data-param]");
      const out = {};
      controls.forEach(c => { out[c.dataset.param] = c.value; });
      state.settings = out;
      return out;
    }

    async function connectBroker() {
      const broker = el.brokerSelect.value;
      const login = el.brokerLogin.value.trim();
      const password = el.brokerPassword.value;
      const server = el.brokerServer.value.trim();
      const terminal_path = el.brokerTerminalPath.value.trim();

      if (!broker) { log("Error: Select a broker first"); return; }
      if (!login || !password || !server) {
        log("Error: Broker login, password, and server are required");
        return;
      }

      if (broker === "Deriv") el.compatibilityLabel.textContent = "Connected via MT5 bridge";
      else el.compatibilityLabel.textContent = "Direct MT5 Execution Mode";

      try {
        const res = await api("/api/broker/connect", {
          method: "POST",
          body: { broker, login, password, server, terminal_path }
        });
        setBrokerStatus(true, `Connected (${res.account?.login || login})`);
        el.brokerPassword.value = ""; // clear sensitive input from UI after connect
        log("Broker Connected");
      } catch (err) {
        setBrokerStatus(false, "Disconnected");
        log(`Error: ${err.message}`);
      }
    }

    async function handleFileUpload(evt) {
      const file = evt.target.files?.[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith(".mq5")) {
        el.fileName.textContent = "Invalid file type";
        log("Error: Only .mq5 upload is allowed");
        state.mq5Loaded = false;
        return;
      }
      const fd = new FormData();
      fd.append("file", file);
      try {
        const res = await api("/api/ea/upload", { method: "POST", formData: fd });
        el.fileName.textContent = file.name;
        state.parameters = res.params || [];
        buildSettingsPanel(state.parameters);
        state.mq5Loaded = true;
      } catch (err) {
        state.mq5Loaded = false;
        log(`Error: ${err.message}`);
      }
    }

    function renderLive(rows = []) {
      const html = rows.slice(0, 100).map(t => {
        const pnl = Number(t.pnl || 0);
        const pnlClass = pnl >= 0 ? "pnl-pos" : "pnl-neg";
        const symbol = String(t.symbol ?? "-");
        const symbolSafe = symbol.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        const symbolBtn = symbol && symbol !== "-" ?
          `<button type="button" class="symbol-jump" data-symbol="${symbolSafe}">${symbolSafe}</button>` :
          "-";
        return `<tr>
          <td>${t.id ?? "-"}</td>
          <td>${symbolBtn}</td>
          <td>${Number(t.lot || 0).toFixed(2)}</td>
          <td>${Number(t.entry || 0).toFixed(2)}</td>
          <td>${Number(t.current || 0).toFixed(2)}</td>
          <td class="${pnlClass}">${pnl.toFixed(2)}</td>
          <td>${t.status || "Open"}</td>
        </tr>`;
      }).join("");
      el.liveBody.innerHTML = html || `<tr><td colspan="7" class="hint">No live transactions</td></tr>`;
    }

    function renderHistory(rows = []) {
      const html = rows.slice(0, 200).map(t => {
        const pnl = Number(t.pnl || 0);
        const pnlClass = pnl >= 0 ? "pnl-pos" : "pnl-neg";
        return `<tr>
          <td>${t.id ?? "-"}</td>
          <td>${t.symbol ?? "-"}</td>
          <td>${Number(t.entry || 0).toFixed(2)}</td>
          <td>${Number(t.exit || 0).toFixed(2)}</td>
          <td class="${pnlClass}">${pnl.toFixed(2)}</td>
          <td>${t.close_time || "-"}</td>
        </tr>`;
      }).join("");
      el.historyBody.innerHTML = html || `<tr><td colspan="6" class="hint">No completed trades</td></tr>`;
    }

    function syncChartSymbolOptions() {
      const candidates = [
        ...Object.keys(state.marketSeries),
        ...state.trades.map(t => String(t.symbol || "").trim()).filter(Boolean),
        ...state.history.map(t => String(t.symbol || "").trim()).filter(Boolean),
      ];
      const symbols = Array.from(new Set(candidates)).sort();
      const prev = el.chartSymbol.value;
      el.chartSymbol.innerHTML = "";

      if (!symbols.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No symbols yet";
        el.chartSymbol.appendChild(opt);
        state.selectedSymbol = "";
        drawMarketChart();
        return;
      }

      symbols.forEach(sym => {
        const opt = document.createElement("option");
        opt.value = sym;
        opt.textContent = sym;
        el.chartSymbol.appendChild(opt);
      });

      const next = symbols.includes(prev) ? prev : (symbols.includes(state.selectedSymbol) ? state.selectedSymbol : symbols[0]);
      state.selectedSymbol = next;
      el.chartSymbol.value = next;
      drawMarketChart();
    }

    function updateMarketSeries(rows = []) {
      const now = Date.now();
      rows.forEach(t => {
        const sym = String(t.symbol || "").trim();
        const price = Number(t.current ?? t.entry);
        if (!sym || !Number.isFinite(price) || price <= 0) return;
        if (!state.marketSeries[sym]) state.marketSeries[sym] = [];
        state.marketSeries[sym].push({ ts: now, price });
        if (state.marketSeries[sym].length > 120) {
          state.marketSeries[sym] = state.marketSeries[sym].slice(-120);
        }
      });
      Object.keys(state.marketSeries).forEach(sym => {
        state.marketSeries[sym] = state.marketSeries[sym].filter(p => now - p.ts < (30 * 60 * 1000));
        if (!state.marketSeries[sym].length) delete state.marketSeries[sym];
      });
      syncChartSymbolOptions();
    }

    function drawEmptyChart(ctx, w, h, message) {
      ctx.fillStyle = "rgba(142,162,204,0.08)";
      ctx.fillRect(0, 0, w, h);
      ctx.fillStyle = "#8ea2cc";
      ctx.font = "14px Segoe UI";
      ctx.textAlign = "center";
      ctx.fillText(message, w / 2, h / 2);
    }

    function drawMarketChart() {
      const canvas = el.marketChart;
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const width = canvas.clientWidth || 600;
      const height = canvas.clientHeight || 300;
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.floor(width * ratio);
      canvas.height = Math.floor(height * ratio);
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.clearRect(0, 0, width, height);

      const symbol = state.selectedSymbol || "";
      if (!symbol) {
        el.chartMeta.textContent = "Waiting for market data...";
        drawEmptyChart(ctx, width, height, "No symbol selected");
        return;
      }

      const series = (state.marketSeries[symbol] || []).slice(-80);
      if (series.length < 2) {
        el.chartMeta.textContent = `${symbol} - waiting for more live ticks`;
        drawEmptyChart(ctx, width, height, "Not enough data yet");
        return;
      }

      const prices = series.map(p => p.price);
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const spread = max - min;
      const pad = spread > 0 ? spread * 0.2 : Math.max(0.00001, max * 0.001);
      const lo = min - pad;
      const hi = max + pad;

      const left = 48;
      const right = 14;
      const top = 16;
      const bottom = 30;
      const plotW = width - left - right;
      const plotH = height - top - bottom;
      const toX = i => left + (i / (series.length - 1)) * plotW;
      const toY = v => top + ((hi - v) / (hi - lo)) * plotH;

      ctx.strokeStyle = "rgba(142,162,204,0.22)";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = top + (i / 4) * plotH;
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(width - right, y);
        ctx.stroke();
      }

      ctx.fillStyle = "#8ea2cc";
      ctx.font = "12px Segoe UI";
      ctx.textAlign = "right";
      ctx.fillText(hi.toFixed(5), left - 6, top + 10);
      ctx.fillText(lo.toFixed(5), left - 6, top + plotH);

      const gradient = ctx.createLinearGradient(0, top, 0, top + plotH);
      gradient.addColorStop(0, "rgba(53,198,255,0.28)");
      gradient.addColorStop(1, "rgba(53,198,255,0.02)");

      ctx.beginPath();
      series.forEach((p, i) => {
        const x = toX(i);
        const y = toY(p.price);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.lineTo(width - right, top + plotH);
      ctx.lineTo(left, top + plotH);
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();

      ctx.beginPath();
      series.forEach((p, i) => {
        const x = toX(i);
        const y = toY(p.price);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.strokeStyle = "#35c6ff";
      ctx.lineWidth = 2;
      ctx.stroke();

      const last = prices[prices.length - 1];
      const first = prices[0];
      const delta = last - first;
      const sign = delta >= 0 ? "+" : "";
      el.chartMeta.textContent = `${symbol} | Last ${last.toFixed(5)} | Change ${sign}${delta.toFixed(5)} | ${series.length} ticks`;
    }

    function focusMarketSymbol(symbol, switchPanel = true) {
      const sym = String(symbol || "").trim();
      if (!sym) return;
      state.selectedSymbol = sym;
      const exists = Array.from(el.chartSymbol.options).some(o => o.value === sym);
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = sym;
        opt.textContent = sym;
        el.chartSymbol.appendChild(opt);
      }
      el.chartSymbol.value = sym;
      if (switchPanel) showPanel("marketPanel");
      drawMarketChart();
    }

    function setEngineState(running) {
      state.eaRunning = !!running;
      el.runStateChip.textContent = `Engine: ${running ? "Running" : "Idle"}`;
      el.runStateChip.style.borderColor = running ? "#1f6f50" : "var(--line)";
    }

    async function startEngine() {
      if (!state.connected) { log("Error: Broker not connected"); return; }
      if (!state.mq5Loaded) { log("Error: Upload EA .mq5 first"); return; }
      const settings = collectSettings();
      try {
        await api("/api/ea/start", { method: "POST", body: { settings } });
        setEngineState(true);
        log("EA execution started");
      } catch (err) {
        log(`Error: ${err.message}`);
      }
    }

    async function stopEngine() {
      try {
        await api("/api/ea/stop", { method: "POST" });
      } catch (_) {}
      setEngineState(false);
      log("EA execution stopped");
    }

    async function restartEngine() {
      const settings = collectSettings();
      try {
        await api("/api/ea/restart", { method: "POST", body: { settings } });
        setEngineState(true);
        log("EA restart triggered");
      } catch (err) {
        log(`Error: ${err.message}`);
      }
    }

    async function pollBackend() {
      if (!state.authenticated) return;
      try {
        const [broker, ea, live, hist, logs] = await Promise.all([
          api("/api/broker/status"),
          api("/api/ea/status"),
          api("/api/trades/live"),
          api("/api/trades/history"),
          api("/api/logs")
        ]);
        setBackendApiState(true, "Connected");
        setBrokerStatus(broker.connected, broker.connected ? "Connected" : "Disconnected");
        state.connected = !!broker.connected;
        state.mq5Loaded = !!ea.ea_loaded;
        state.trades = live.trades || [];
        state.history = hist.trades || [];
        setEngineState(!!ea.running);
        renderLive(state.trades);
        renderHistory(state.history);
        updateMarketSeries(state.trades);
        (logs.logs || []).forEach(item => log(item.msg || "", true));
      } catch (err) {
        setBackendApiState(false, "Disconnected");
        setBrokerStatus(false, "Disconnected");
        if (!isFileMode()) log(`Backend poll error: ${err.message}`);
      }
    }

    function startPolling() {
      stopPolling();
      pollBackend();
      state.poller = setInterval(pollBackend, 2000);
    }

    function stopPolling() {
      if (state.poller) clearInterval(state.poller);
      state.poller = null;
    }

    function wire() {
      el.loginForm.addEventListener("submit", handleLogin);
      el.logoutBtn.addEventListener("click", logout);
      el.backendApiBtn.addEventListener("click", toggleBackendApi);
      el.connectBtn.addEventListener("click", connectBroker);
      el.mq5File.addEventListener("change", handleFileUpload);
      el.startBtn.addEventListener("click", startEngine);
      el.stopBtn.addEventListener("click", stopEngine);
      el.restartBtn.addEventListener("click", restartEngine);
      el.liveBody.addEventListener("click", (evt) => {
        const btn = evt.target.closest(".symbol-jump");
        if (!btn) return;
        focusMarketSymbol(btn.dataset.symbol || "", true);
      });
      el.chartSymbol.addEventListener("change", () => {
        state.selectedSymbol = el.chartSymbol.value;
        drawMarketChart();
      });
      window.addEventListener("resize", drawMarketChart);
      el.brokerSelect.addEventListener("change", () => {
        const v = el.brokerSelect.value;
        if (v === "Deriv") el.compatibilityLabel.textContent = "Connected via MT5 bridge";
        else if (v === "MetaTrader5") el.compatibilityLabel.textContent = "Direct MT5 Execution Mode";
        else el.compatibilityLabel.textContent = "Broker accepted by MetaTrader5";
      });
      el.apiBase.addEventListener("change", () => {
        state.apiSessionToken = "";
        setBackendApiState(false, "Disconnected");
        stopPolling();
        if (state.authenticated) log("Backend API URL changed. Click Connect Backend to retry.");
      });
      initPanels();
      if (isFileMode()) {
        log("Tip: open this page via local server and run backend on http://127.0.0.1:8787");
      }
    }

    wire();
    setBackendApiState(false, "Disconnected");
    loadSession();
    renderLive([]);
    renderHistory([]);
    drawMarketChart();
    log("Dashboard initialized");
  </script>
</body>
</html>
